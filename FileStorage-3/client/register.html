<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>FileStorage ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/auth.css" />
  </head>
  <body class="auth-page">
    <h1>FileStorage</h1>
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

    <form id="registerForm">
      <label>
        E-mail:
        <input
          type="email"
          name="email"
          pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
          required
        />
        <span class="validation-message" id="emailError"></span>
      </label>

      <label>
        –ü–∞—Ä–æ–ª—å:
        <div class="password-container">
          <input
            type="password"
            name="password"
            pattern="[0-9]{8}"
            required
            placeholder=" "
          />
          <span class="password-toggle" id="passwordToggle">üëÅÔ∏è</span>
        </div>
        <em class="password-hint">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 8 —Ü–∏—Ñ—Ä</em>
        <span class="validation-message" id="passwordError"></span>
      </label>

      <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

      <!-- –î–æ–±–∞–≤–ª—è–µ–º div –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
      <div id="statusMessage" class="status-message"></div>
    </form>

    <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="/">–í–æ–π—Ç–∏</a></p>

    <script>
      const form = document.getElementById("registerForm");
      const statusMessage = document.getElementById("statusMessage");
      const emailInput = form.querySelector('input[name="email"]');
      const passwordInput = form.querySelector('input[name="password"]');
      const emailError = document.getElementById("emailError");
      const passwordError = document.getElementById("passwordError");
      const passwordToggle = document.getElementById("passwordToggle");

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
      if (passwordToggle) {
        passwordToggle.addEventListener("click", function (e) {
          e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
          const type = passwordInput.getAttribute("type");
          if (type === "password") {
            passwordInput.setAttribute("type", "text");
            this.textContent = "üîí";
          } else {
            passwordInput.setAttribute("type", "password");
            this.textContent = "üëÅÔ∏è";
          }
        });
      }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è email
      emailInput.addEventListener("input", function () {
        if (this.validity.patternMismatch || this.validity.typeMismatch) {
          emailError.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å";
        } else {
          emailError.textContent = "";
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = {
          email: formData.get("email"),
          password: formData.get("password"),
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        if (data.password.length < 8) {
          passwordError.textContent = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 8 —Ü–∏—Ñ—Ä";
          statusMessage.className = "status-message error";
          return;
        }

        if (data.password.length > 8) {
          passwordError.textContent = "–ü–∞—Ä–æ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 8 —Ü–∏—Ñ—Ä";
          statusMessage.className = "status-message error";
          return;
        }

        try {
          const response = await fetch("/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await response.text();

          if (response.ok) {
            statusMessage.textContent =
              "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞.";
            statusMessage.className = "status-message success";
            form.reset();
          } else {
            statusMessage.textContent = result;
            statusMessage.className = "status-message error";
          }
        } catch (error) {
          statusMessage.textContent =
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
          statusMessage.className = "status-message error";
        }
      });
    </script>
  </body>
</html>
